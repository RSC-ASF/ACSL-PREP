<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Short Problems - ACSL Prep</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <span class="logo-icon">◆</span>
                ACSL<span class="accent">Prep</span>
            </a>
            <div class="nav-menu">
                <a href="../index.html" class="nav-link">Home</a>
                <a href="contests.html" class="nav-link">Contests</a>
                <a href="leaderboard.html" class="nav-link">Leaderboard</a>
                <div id="auth-nav" class="auth-nav">
                    <button id="sign-in-btn" class="btn btn-primary">Sign In</button>
                </div>
                <div id="user-nav" class="user-nav hidden">
                    <a href="profile.html" class="nav-link profile-link">
                        <img id="user-avatar" src="" alt="Profile" class="user-avatar">
                        <span id="user-name"></span>
                    </a>
                    <button id="sign-out-btn" class="btn btn-secondary">Sign Out</button>
                </div>
            </div>
            <button class="nav-toggle" id="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- Problem Navigation Bar -->
    <div class="problem-nav">
        <div class="problem-nav-info">
            <a href="contests.html" class="btn btn-secondary btn-small">← Back</a>
            <span id="contest-title">Contest 1 - Short Problems</span>
        </div>
        <div class="problem-nav-dots" id="problem-dots">
            <!-- Dots will be generated dynamically -->
        </div>
        <div class="problem-nav-controls">
            <button id="prev-btn" class="btn btn-secondary btn-small" disabled>Previous</button>
            <span id="problem-counter">1 / 10</span>
            <button id="next-btn" class="btn btn-secondary btn-small">Next</button>
        </div>
    </div>

    <div class="page-container" style="padding-top: 120px;">
        <div class="page-content">
            <div class="container">
                <div class="problem-container">
                    <!-- Question Panel -->
                    <div class="problem-panel">
                        <div class="problem-header">
                            <h3>Question <span id="question-number">1</span></h3>
                            <span id="problem-status" class="problem-status">Not Attempted</span>
                        </div>
                        <div class="problem-content">
                            <div id="question-image-container">
                                <img id="question-image" src="" alt="Question" class="problem-image">
                                <p id="no-question" class="no-content">No question image found. Add images to
                                    problems/contest1/short/questions/</p>
                            </div>
                        </div>
                    </div>

                    <!-- Answer Panel -->
                    <div class="problem-panel">
                        <div class="problem-header">
                            <h3>Answer</h3>
                            <button id="reveal-btn" class="btn btn-primary btn-small">Reveal Answer</button>
                        </div>
                        <div class="problem-content">
                            <div id="answer-container" class="answer-container">
                                <img id="answer-image" src="" alt="Answer" class="problem-image answer-blur">
                                <div class="answer-overlay">
                                    <button id="reveal-overlay-btn" class="btn btn-primary">Click to Reveal</button>
                                </div>
                                <p id="no-answer" class="no-content hidden">No answer image found. Add images to
                                    problems/contest1/short/answers/</p>
                            </div>
                        </div>
                        <div class="problem-footer">
                            <button id="mark-complete-btn" class="btn btn-primary" style="width: 100%;">
                                Mark as Complete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .problem-nav {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            z-index: 999;
        }

        .problem-nav-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        #problem-counter {
            font-size: 0.875rem;
            color: var(--text-secondary);
            min-width: 60px;
            text-align: center;
        }

        .problem-status {
            font-size: 0.75rem;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .problem-status.completed {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .problem-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .no-content {
            text-align: center;
            color: var(--text-muted);
            padding: var(--spacing-2xl);
        }

        @media (max-width: 768px) {
            .problem-nav {
                flex-wrap: wrap;
                gap: var(--spacing-sm);
                padding: var(--spacing-sm);
            }

            .problem-nav-dots {
                order: 3;
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>

    <script type="module" src="../js/firebase-config.js"></script>
    <script type="module" src="../js/auth.js"></script>
    <script type="module">
        import { signInWithGoogle, handleSignOut, showToast, getCurrentUser } from '../js/auth.js';
        import { auth, db, doc, getDoc, updateDoc } from '../js/firebase-config.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { arrayUnion } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Get contest number from URL
        const urlParams = new URLSearchParams(window.location.search);
        const contestNum = urlParams.get('contest') || '1';
        const totalProblems = 10;
        let currentProblem = 1;
        let completedProblems = [];
        let currentUser = null;

        // Update page title
        document.getElementById('contest-title').textContent = `Contest ${contestNum} - Short Problems`;
        document.title = `Contest ${contestNum} Short Problems - ACSL Prep`;

        // Auth buttons
        document.getElementById('sign-in-btn')?.addEventListener('click', signInWithGoogle);
        document.getElementById('sign-out-btn')?.addEventListener('click', handleSignOut);

        // Navigation toggle
        document.getElementById('nav-toggle')?.addEventListener('click', () => {
            document.querySelector('.nav-menu').classList.toggle('active');
        });

        // Generate problem dots
        function generateDots() {
            const dotsContainer = document.getElementById('problem-dots');
            dotsContainer.innerHTML = '';
            for (let i = 1; i <= totalProblems; i++) {
                const dot = document.createElement('button');
                dot.className = 'nav-dot';
                if (i === currentProblem) dot.classList.add('active');
                if (completedProblems.includes(i)) dot.classList.add('completed');
                dot.addEventListener('click', () => loadProblem(i));
                dotsContainer.appendChild(dot);
            }
        }

        // Load problem
        function loadProblem(num) {
            currentProblem = num;

            // Update UI
            document.getElementById('question-number').textContent = num;
            document.getElementById('problem-counter').textContent = `${num} / ${totalProblems}`;

            // Update navigation buttons
            document.getElementById('prev-btn').disabled = num === 1;
            document.getElementById('next-btn').disabled = num === totalProblems;

            // Update dots
            document.querySelectorAll('.nav-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i + 1 === num);
            });

            // Load question image
            const questionImg = document.getElementById('question-image');
            const questionPath = `../problems/contest${contestNum}/short/questions/${num}.png`;
            questionImg.src = questionPath;
            questionImg.onerror = () => {
                questionImg.style.display = 'none';
                document.getElementById('no-question').style.display = 'block';
            };
            questionImg.onload = () => {
                questionImg.style.display = 'block';
                document.getElementById('no-question').style.display = 'none';
            };

            // Load answer image
            const answerImg = document.getElementById('answer-image');
            const answerPath = `../problems/contest${contestNum}/short/answers/${num}.png`;
            answerImg.src = answerPath;
            answerImg.onerror = () => {
                answerImg.style.display = 'none';
                document.getElementById('no-answer').classList.remove('hidden');
            };
            answerImg.onload = () => {
                answerImg.style.display = 'block';
                document.getElementById('no-answer').classList.add('hidden');
            };

            // Reset answer reveal
            document.getElementById('answer-container').classList.remove('revealed');

            // Update status
            const isCompleted = completedProblems.includes(num);
            const statusEl = document.getElementById('problem-status');
            statusEl.textContent = isCompleted ? 'Completed' : 'Not Attempted';
            statusEl.className = 'problem-status' + (isCompleted ? ' completed' : '');

            document.getElementById('mark-complete-btn').textContent =
                isCompleted ? '✓ Completed' : 'Mark as Complete';
        }

        // Reveal answer
        function revealAnswer() {
            document.getElementById('answer-container').classList.add('revealed');
        }

        document.getElementById('reveal-btn').addEventListener('click', revealAnswer);
        document.getElementById('reveal-overlay-btn').addEventListener('click', revealAnswer);

        // Navigation
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentProblem > 1) loadProblem(currentProblem - 1);
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentProblem < totalProblems) loadProblem(currentProblem + 1);
        });

        // Mark as complete
        document.getElementById('mark-complete-btn').addEventListener('click', async () => {
            if (!currentUser) {
                showToast('Please sign in to track your progress', 'error');
                return;
            }

            if (!completedProblems.includes(currentProblem)) {
                completedProblems.push(currentProblem);

                // Update Firestore
                try {
                    const userRef = doc(db, 'users', currentUser.uid);
                    await updateDoc(userRef, {
                        [`progress.contest${contestNum}.short`]: arrayUnion(currentProblem),
                        'stats.totalProblemsCompleted': (await getDoc(userRef)).data().stats.totalProblemsCompleted + 1,
                        'stats.shortProblemsCompleted': (await getDoc(userRef)).data().stats.shortProblemsCompleted + 1
                    });

                    showToast('Progress saved!', 'success');
                } catch (error) {
                    console.error('Error saving progress:', error);
                    showToast('Error saving progress', 'error');
                }

                // Update UI
                generateDots();
                loadProblem(currentProblem);
            }
        });

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                // Load user progress
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const progress = userDoc.data().progress;
                    completedProblems = progress[`contest${contestNum}`]?.short || [];
                    generateDots();
                    loadProblem(currentProblem);
                }
            } else {
                completedProblems = [];
                generateDots();
                loadProblem(currentProblem);
            }
        });

        // Initial load
        generateDots();
        loadProblem(1);
    </script>
</body>

</html>