<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Short Problems - ACSL Prep</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo"><span class="logo-icon">◆</span>ACSL<span
                    class="accent">Prep</span></a>
            <div class="nav-menu">
                <a href="../index.html" class="nav-link">Home</a>
                <a href="leaderboard.html" class="nav-link">Leaderboard</a>
                <div id="auth-nav" class="auth-nav"><button id="sign-in-btn" class="btn btn-primary">Sign In</button>
                </div>
                <div id="user-nav" class="user-nav hidden">
                    <a href="profile.html" class="nav-link profile-link"><img id="user-avatar" src="" alt="Profile"
                            class="user-avatar"><span id="user-name"></span></a>
                    <button id="sign-out-btn" class="btn btn-secondary">Sign Out</button>
                </div>
            </div>
            <button class="nav-toggle" id="nav-toggle"><span></span><span></span><span></span></button>
        </div>
    </nav>

    <div class="problem-nav">
        <div class="problem-nav-info">
            <a href="../index.html" class="btn btn-secondary btn-small">← Back</a>
            <span id="contest-title">Contest 1 - Short Problems</span>
        </div>
        <div class="problem-nav-dots" id="problem-dots"></div>
        <div class="problem-nav-controls">
            <button id="prev-btn" class="btn btn-secondary btn-small" disabled>Previous</button>
            <span id="problem-counter">1 / 30</span>
            <button id="next-btn" class="btn btn-secondary btn-small">Next</button>
        </div>
    </div>

    <div class="page-container" style="padding-top: 120px;">
        <div class="page-content">
            <div class="container">
                <div class="short-problem-layout">
                    <div class="problem-panel">
                        <div class="problem-header">
                            <div>
                                <h3>Question <span id="question-number">1</span></h3>
                                <span id="problem-topic" class="problem-topic">Number Systems</span>
                            </div>
                            <div class="header-right">
                                <span id="difficulty-badge" class="difficulty-badge easy">Easy</span>
                                <span id="problem-status" class="problem-status">Not Attempted</span>
                            </div>
                        </div>
                        <div class="problem-content">
                            <div id="question-content" class="question-text">Loading question...</div>
                        </div>
                    </div>
                    <div class="problem-panel">
                        <div class="problem-header">
                            <h3>Your Answer</h3>
                        </div>
                        <div class="problem-content">
                            <div class="answer-input-section">
                                <input type="text" id="user-answer" class="form-input answer-input"
                                    placeholder="Type your answer here..." autocomplete="off">
                                <button id="check-btn" class="btn btn-primary">Check Answer</button>
                            </div>
                            <div id="feedback-section" class="feedback-section hidden">
                                <div id="feedback-message" class="feedback-message"></div>
                                <div id="correct-answer" class="correct-answer hidden"><strong>Correct Answer:</strong>
                                    <span id="answer-text"></span>
                                </div>
                                <div id="explanation" class="explanation hidden"><strong>Explanation:</strong> <span
                                        id="explanation-text"></span></div>
                            </div>
                        </div>
                        <div class="problem-footer"><button id="next-problem-btn" class="btn btn-primary"
                                style="width: 100%;">Next Problem →</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .short-problem-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            min-height: calc(100vh - 250px);
        }

        @media (max-width: 968px) {
            .short-problem-layout {
                grid-template-columns: 1fr;
            }
        }

        .problem-nav {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            z-index: 999;
        }

        .problem-nav-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        #problem-counter {
            font-size: 0.875rem;
            color: var(--text-secondary);
            min-width: 60px;
            text-align: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .problem-topic {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .difficulty-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            text-transform: uppercase;
        }

        .difficulty-badge.easy {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .difficulty-badge.medium {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .difficulty-badge.hard {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .problem-status {
            font-size: 0.75rem;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .problem-status.completed {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .problem-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .question-text {
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .question-text code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-family: 'Fira Code', monospace;
        }

        .question-text pre {
            background: var(--bg-tertiary);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin: var(--spacing-md) 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
        }

        .answer-input-section {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .answer-input {
            flex: 1;
            font-size: 1.1rem;
            font-family: 'Fira Code', monospace;
        }

        .feedback-section {
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
        }

        .feedback-message {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }

        .feedback-message.correct {
            color: var(--success);
        }

        .feedback-message.incorrect {
            color: var(--error);
        }

        .correct-answer,
        .explanation {
            margin-top: var(--spacing-md);
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .correct-answer span,
        .explanation span {
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .problem-nav {
                flex-wrap: wrap;
                gap: var(--spacing-sm);
                padding: var(--spacing-sm);
            }

            .problem-nav-dots {
                order: 3;
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .answer-input-section {
                flex-direction: column;
            }
        }
    </style>

    <script type="module" src="../js/firebase-config.js"></script>
    <script type="module" src="../js/auth.js"></script>
    <script type="module">
        import { signInWithGoogle, handleSignOut, showToast } from '../js/auth.js';
        import { auth, db, doc, getDoc, updateDoc } from '../js/firebase-config.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { arrayUnion } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const urlParams = new URLSearchParams(window.location.search);
        const contestNum = urlParams.get('contest') || '1';
        let problems = [];
        let currentProblem = 0;
        let completedProblems = [];
        let currentUser = null;

        document.getElementById('contest-title').textContent = `Contest ${contestNum} - Short Problems`;
        document.title = `Contest ${contestNum} Short Problems - ACSL Prep`;
        document.getElementById('sign-in-btn')?.addEventListener('click', signInWithGoogle);
        document.getElementById('sign-out-btn')?.addEventListener('click', handleSignOut);
        document.getElementById('nav-toggle')?.addEventListener('click', () => document.querySelector('.nav-menu').classList.toggle('active'));

        async function loadProblems() {
            try {
                const response = await fetch(`../problems/contest${contestNum}/short/problems.json`);
                if (response.ok) { problems = await response.json(); generateDots(); loadProblem(0); }
                else { document.getElementById('question-content').innerHTML = '<p>No problems found.</p>'; }
            } catch (e) { document.getElementById('question-content').innerHTML = '<p>Error loading problems.</p>'; }
        }

        function generateDots() {
            const c = document.getElementById('problem-dots'); c.innerHTML = '';
            for (let i = 0; i < Math.min(problems.length, 20); i++) {
                const d = document.createElement('button'); d.className = 'nav-dot';
                if (i === currentProblem) d.classList.add('active');
                if (completedProblems.includes(i)) d.classList.add('completed');
                d.addEventListener('click', () => loadProblem(i)); c.appendChild(d);
            }
        }

        function loadProblem(idx) {
            if (idx < 0 || idx >= problems.length) return;
            currentProblem = idx; const p = problems[idx];
            document.getElementById('question-number').textContent = idx + 1;
            document.getElementById('problem-counter').textContent = `${idx + 1} / ${problems.length}`;
            document.getElementById('prev-btn').disabled = idx === 0;
            document.getElementById('next-btn').disabled = idx === problems.length - 1;
            document.querySelectorAll('.nav-dot').forEach((d, i) => d.classList.toggle('active', i === idx));
            document.getElementById('question-content').innerHTML = p.question;
            document.getElementById('problem-topic').textContent = p.topic || 'General';
            const db = document.getElementById('difficulty-badge');
            db.textContent = p.difficulty || 'Easy'; db.className = `difficulty-badge ${(p.difficulty || 'easy').toLowerCase()}`;
            document.getElementById('user-answer').value = '';
            document.getElementById('feedback-section').classList.add('hidden');
            document.getElementById('user-answer').disabled = false;
            document.getElementById('check-btn').disabled = false;
            const s = document.getElementById('problem-status');
            s.textContent = completedProblems.includes(idx) ? 'Completed' : 'Not Attempted';
            s.className = 'problem-status' + (completedProblems.includes(idx) ? ' completed' : '');
        }

        document.getElementById('check-btn').addEventListener('click', checkAnswer);
        document.getElementById('user-answer').addEventListener('keypress', e => { if (e.key === 'Enter') checkAnswer(); });

        async function checkAnswer() {
            const p = problems[currentProblem], ua = document.getElementById('user-answer').value.trim();
            if (!ua) { showToast('Please enter an answer', 'error'); return; }
            const fs = document.getElementById('feedback-section'), fm = document.getElementById('feedback-message');
            const ca = document.getElementById('correct-answer'), ex = document.getElementById('explanation');
            fs.classList.remove('hidden');
            const nu = ua.toLowerCase().replace(/\s+/g, ''), nc = p.answer.toLowerCase().replace(/\s+/g, '');
            let correct = nu === nc;
            if (p.alternateAnswers) correct = correct || p.alternateAnswers.some(a => a.toLowerCase().replace(/\s+/g, '') === nu);
            if (correct) {
                fm.textContent = '✓ Correct!'; fm.className = 'feedback-message correct'; ca.classList.add('hidden');
                if (!completedProblems.includes(currentProblem)) {
                    completedProblems.push(currentProblem); generateDots();
                    document.getElementById('problem-status').textContent = 'Completed';
                    document.getElementById('problem-status').className = 'problem-status completed';
                    if (currentUser) {
                        try {
                            const ur = doc(db, 'users', currentUser.uid), ud = (await getDoc(ur)).data();
                            await updateDoc(ur, { [`progress.contest${contestNum}.short`]: arrayUnion(currentProblem), 'stats.totalProblemsCompleted': (ud.stats?.totalProblemsCompleted || 0) + 1, 'stats.shortProblemsCompleted': (ud.stats?.shortProblemsCompleted || 0) + 1 });
                        } catch (e) { console.error(e); }
                    }
                }
            } else { fm.textContent = '✗ Incorrect'; fm.className = 'feedback-message incorrect'; ca.classList.remove('hidden'); document.getElementById('answer-text').textContent = p.answer; }
            if (p.explanation) { ex.classList.remove('hidden'); document.getElementById('explanation-text').textContent = p.explanation; } else { ex.classList.add('hidden'); }
            document.getElementById('user-answer').disabled = true; document.getElementById('check-btn').disabled = true;
        }

        document.getElementById('prev-btn').addEventListener('click', () => { if (currentProblem > 0) loadProblem(currentProblem - 1); });
        document.getElementById('next-btn').addEventListener('click', () => { if (currentProblem < problems.length - 1) loadProblem(currentProblem + 1); });
        document.getElementById('next-problem-btn').addEventListener('click', () => { if (currentProblem < problems.length - 1) loadProblem(currentProblem + 1); else showToast('All problems completed!', 'success'); });

        onAuthStateChanged(auth, async user => {
            currentUser = user;
            if (user) { const ud = await getDoc(doc(db, 'users', user.uid)); if (ud.exists()) { completedProblems = ud.data().progress?.[`contest${contestNum}`]?.short || []; generateDots(); loadProblem(currentProblem); } }
        });

        loadProblems();
    </script>
</body>

</html>